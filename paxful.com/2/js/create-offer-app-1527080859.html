var createOfferApp = angular.module('createOfferApp', ['ui.router', 'scania.angular.select2', 'angularModalService'], function($interpolateProvider) {
    $interpolateProvider.startSymbol('<%');
    $interpolateProvider.endSymbol('%>');
});

createOfferApp.config(['$stateProvider', '$urlRouterProvider', '$locationProvider',
    function($stateProvider, $urlRouterProvider, $locationProvider) {

        $urlRouterProvider.otherwise('/');
        $locationProvider.html5Mode(true).hashPrefix('!');

        $stateProvider
            .state('app', {
                abstract: true,
                template: '<ui-view />',
                controller: 'MainCtrl',
                resolve: {
                    paymentMethods: function(offerLibrary) {
                        return offerLibrary.getPaymentMethods();
                    },
                    currencies: function(offerLibrary) {
                        return offerLibrary.getCurrencies();
                    },
                    offerTags: function(offerLibrary) {
                        return offerLibrary.getOfferTags();
                    }
                }
            })
            .state('step1', {
                url: '/',
                parent: 'app',
                templateUrl: '/create-offer-app/step1',
                controller: 'PaymentMethodCtrl',
                resolve: {
                    e: function(offerLibrary) {
                        return offerLibrary.handleStateError('step1');
                    },
                }
            })
            .state('step2', {
                url: '/',
                parent: 'app',
                templateUrl: '/create-offer-app/step2',
                controller: 'MoneyCtrl',
                resolve: {
                    e: function(offerLibrary) {
                        return offerLibrary.handleStateError('step2');
                    },
                }
            })
            .state('step3', {
                url: '/',
                parent: 'app',
                templateUrl: '/create-offer-app/step3',
                controller: 'TermsCtrl',
                resolve: {
                    e: function(offerLibrary) {
                        return offerLibrary.handleStateError('step3');
                    }
                }
            });
    }
]);

createOfferApp.run(['$rootScope', 'offerLibrary', function ($rootScope, offerLibrary) {
    // So you decided not to create-update offer after all? Leaving the page it cleans the formData object
    if (performance.navigation.type !== 1) {
        offerLibrary.cleanStateData();
    }
}]);

// Margin and min/max amount controller.
createOfferApp.controller('HeaderCtrl', ['$scope', '$rootScope', '$state', '$stateParams', '$transitions',
    function ($scope, $rootScope, $state, $stateParams, $transitions) {

        $scope.stepsInfo = null;
        $scope.currentStepName = $state.$current.name;

        $scope.$on('stepsInfo', function (event, arg) {
            $scope.stepsInfo = arg;
        });

        // Watcher: Updates current step name.
        $transitions.onSuccess({ }, function($transitions) {
            $scope.currentStepName = $transitions.$to().name;
        });

        $scope.getStepObjectByName = function(stepName) {
            return getObjects($scope.stepsInfo, 'value', stepName)[0];
        };

        // Get current step index value from step object.
        $scope.getCurrentStepNumericalValue = function(stepName) {
            return $scope.getStepObjectByName(stepName).numerical_value;
        };
    }
]);

// Main controller for all steps
createOfferApp.controller('MainCtrl', ['$scope', '$rootScope', 'paymentMethods', '$state', 'offerLibrary', '$window', '$transitions', 'currencies', '$location', '$anchorScroll', 'ModalService',
    function ($scope, $rootScope, paymentMethods, $state, offerLibrary, $window, $transitions, currencies, $location, $anchorScroll, ModalService) {

        // For mobile configuration

        $rootScope.anchorScroll = $anchorScroll;

        $rootScope.isMobileView = ($window.innerWidth < 767);
        $scope.isMobileView = false;

        $scope.$watch(function () {
            return $window.innerWidth;
        }, function (innerWidth) {
            $scope.isMobileView = innerWidth < 767;
        });

        // $scope.initVariables - everything passed from php

        $scope.isLoggedIn = $scope.initVariables.authorized;
        // $scope.currencyMax = $scope.initVariables.fiat_max;

        // Ajax loaded payment methods from offerLibrary -> getPaymentMethods or the hardcoded JSON
        $scope.paymentMethods = $scope.isLoggedIn ? paymentMethods.data : paymentMethodSample;

        // Main form error object.
        $scope.formErrorData = {
            step1: {},
            step2: {},
            step3: {},
            server: {}
        };

        // If offer is edited
        if ($scope.initVariables.edit) {
            $rootScope.formData = $scope.initVariables.editParams;
            if (isNotEmptyArray($rootScope.formData.predefined_amount)) {
                $rootScope.formData.predefinedAmounts = true;
                $rootScope.formData.predefinedAmountsEditMode = true;
            }
        } else {
            $rootScope.formData = offerLibrary.getStateDataExact('formData') || {};
            $rootScope.formData.offer_type_field = $rootScope.formData.offer_type_field || 2; // By default it's a sell offer
            $rootScope.formData.predefinedAmounts = $rootScope.formData.predefinedAmounts || false;
        }

        if ($rootScope.formData.payment_method_group_id) {
            $scope.selectPaymentMethod($rootScope.formData.payment_method_group_id);
        } else {
            $rootScope.activeGroup = 1;
        }

        $rootScope.formData._token = document.head.querySelector("[name=_token]").content;

        // Navigation control.
        $scope.stepsInfo = offerLibrary.getStateDataExact('stepsInfo') || $scope.initVariables.steps;
        $scope.currentStepName = $state.current.name;
        $scope.stepHasErrors = false;
        $scope.nextStepButtonText = 'Next step';

        $scope.offerAgreementMessage = false;
        $scope.deleteErrorMessage = false;
        $rootScope.showSpinners = false;
        $rootScope.unknownError = false;
        $rootScope.serverError = false;

        // Currency and country options

        $rootScope.selectOptions = {
            countries: $scope.initVariables.countries,
            currencies: currencies.data.fiatCurrencies,
            iso_countries: $scope.initVariables.iso_countries
        };

        $rootScope.isSellOffer = function() {
            return $rootScope.formData.offer_type_field == 2;
        }

        $rootScope.isBuyOffer = function() {
            return $rootScope.formData.offer_type_field == 1;
        }

        $scope.submitStep = function(stepName) {

            $scope.stepHasErrors = $scope.validateAndCheckStepForErrors(stepName);
            if (!$scope.stepHasErrors) {
                if ($scope.isLastStep(stepName)) {
                    if (!$scope.showSpinners) {
                        $scope.showSpinners = true;
                        if ($rootScope.isBuyOffer() || ($rootScope.isSellOffer() && $scope.initVariables.is_vendor === true)) {
                            createNewOffer();
                        } else {
                            $scope.formErrorData[stepName] = {};
                            offerLibrary.saveStateData({stepsInfo: $scope.stepsInfo, formData: $scope.formData});
                            $scope.showTermsAgreementModal();
                        }
                    }
                } else {
                    var step = $scope.getCurrentStepNumericalValue(stepName);
                    $scope.stepsInfo[step].completed = true;
                    $scope.stepsInfo[step].active = false;
                    $scope.stepsInfo[step + 1].active = true;
                    // Broadcast: We need this broadcast to share step data with header controller not included in view.
                    $rootScope.$broadcast('stepsInfo', $scope.stepsInfo);
                    offerLibrary.saveStateData({stepsInfo: $scope.stepsInfo, formData: $scope.formData});
                    $rootScope.formData = $scope.formData;
                    // $scope.showSpinners = true;
                    $state.go($scope.getNextStepObject($scope.currentStepName).value);
                }
            }
        };

        $rootScope.resetError = function() {
            $scope.unknownError = false;
        }

        $rootScope.handleError = function(reason) {
            $scope.unknownError = true;
            $scope.serverError = false;
            $scope.formErrorData.server = {};

            $scope.showSpinners = false;
            $scope.deleteInProgress = false;

            console.log("Request Failed");
            console.log(reason);
        }

        var createNewOffer = function () {

            // predefined amounts
            if (!$scope.formData.predefinedAmounts) {
                $scope.formData.predefined_amount = null;
            }

            // payment method label or bank name
            if ($scope.isSelectedPaymentMethodBankTransfer()) {
                $scope.formData.payment_method_label = null;
            } else {
                $scope.formData.bank_name = null;
            }

            $scope.showSpinners = true;
            $scope.unknownError = false;
            $scope.serverError = false;
            $scope.formErrorData.server = {};

            // API: Submit new offer
            offerLibrary.postNewOffer($scope.formData)
                .then(function(response) {
                    if(response.data.status === 'error') {
                        if (response.data.unknown_error) {
                            $scope.handleError(response.data);
                        } else {
                            $scope.showSpinners = false;
                            angular.forEach(response.data.error_fields, function(value, key) {
                                $scope.serverError = true;
                                $scope.formErrorData.server[key] = value[0];
                            });
                        }
                    } else {
                        window.location.href = '/vendor/dashboard?created_offer=' + response.data.data.offerHash + '&action=' + ($scope.initVariables.edit ? 'update' : 'save');
                    }
                });
        };

        // Submit current step.
        $scope.goBackStep = function(stepName) {
            $state.go($scope.getPreviousStepObject(stepName).value);
            $rootScope.formData = $scope.formData;
            $scope.stepBack = true; // hack for the bug of the scania-angular-select2, which is not applies custom tags to the model
        };

        $scope.getCurrentStepObject = function() {
            var currentStepNumericalValue = $scope.getCurrentStepNumericalValue($scope.currentStepName);
            return $scope.stepsInfo[currentStepNumericalValue];
        };

        $scope.getStepObjectByName = function(stepName) {
            return getObjects($scope.stepsInfo, 'value', stepName)[0];
        };

        // Get current step index value from step object.
        $scope.getCurrentStepNumericalValue = function(stepName) {
            return stepName ? $scope.getStepObjectByName(stepName).numerical_value : 'step1';
        };

        // Check if not first step.
        $scope.canGoBack = function(stepName) {
            var currentStepNumericalValue = $scope.getCurrentStepNumericalValue(stepName);
            return currentStepNumericalValue !== 1;
        };

        $scope.validateAndCheckStepForErrors = function(stepName) {

            angular.forEach($scope.currentStep.validations, function(value, key) {
                var val = $scope.formData[key];
                var error = $scope.getValidationMessage(key, val);
                if (error) {
                    $scope.formErrorData[$scope.currentStepName][key] = error;
                }
            });

            // exception for pm label as bank name
            if (stepName === 'step1' && !$scope.isSelectedPaymentMethodBankTransfer()) {
                delete $scope.formErrorData[$scope.currentStepName]['bank_name'];
            }

            // exception for predefined amounts - need to remove mutually exclusive validation messages
            if ($scope.formData.predefinedAmounts) {
                delete $scope.formErrorData[$scope.currentStepName]['range_min'];
                delete $scope.formErrorData[$scope.currentStepName]['range_max'];
            } else {
                delete $scope.formErrorData[$scope.currentStepName]['predefined_amount'];
            }

            var fieldsWithErrors = Object.keys($scope.formErrorData[$scope.currentStepName]);
            if (fieldsWithErrors.length > 0) {
                // manually described scrolling to field with errors, sorry for that
                if ($scope.isMobileView) {
                    if (stepName == 'step1') {
                        if(fieldsWithErrors.indexOf('payment_method_id') !== -1) {
                            $anchorScroll('payment_method_id');
                        } else if(fieldsWithErrors.indexOf('currency') !== -1) {
                            $anchorScroll('currency');
                        }
                    } else if (stepName == 'step2') {
                        if(fieldsWithErrors.indexOf('margin') !== -1) {
                            $anchorScroll('margin');
                        } else if(fieldsWithErrors.indexOf('range_min') !== -1 || fieldsWithErrors.indexOf('range_max') !== -1 || fieldsWithErrors.indexOf('predefined_amount') !== -1) {
                            $anchorScroll('range');
                        } else if(fieldsWithErrors.indexOf('payment_window') !== -1) {
                            $anchorScroll('payment_window');
                        }
                    } else if (stepName == 'step3') {
                        if(fieldsWithErrors.indexOf('offer_terms') !== -1) {
                            $anchorScroll('offer_terms');
                        } else if(fieldsWithErrors.indexOf('trade_details') !== -1) {
                            $anchorScroll('trade_details');
                        }
                    }
                }
                return true;
            }
            return false;
        };

        $scope.getValidationMessage = function(key, val) {
            if (val === null || val === '' || val === undefined || (Array.isArray(val) && val.length === 0)) {
                return $scope.currentStep.validations[key];
            } else {
                if (key === 'margin') {
                    return $scope.getMarginValidationMessage();
                } else if (key === 'range_min' || key === 'range_max') {
                    return $scope.getRangeValidationMessage(key, val);
                } else if (key === 'predefined_amount') {
                    return $scope.getPredefinedAmountsValidationMessage();
                } else if (key === 'payment_window') {
                    return $scope.getPaymentWindowValidationMessage();
                }
            }
            return false;
        };

        $scope.getMarginValidationMessage = function() {
            var min = $scope.initVariables.margin_min;
            var max = $scope.initVariables.margin_max;
            if ($rootScope.isBuyOffer()) {
                max = $scope.initVariables.margin_rates_by_payment_groups[$rootScope.activeGroup];
            }
            var val = $scope.formData.margin;
            if (val < min || val > max) {
                var error = $scope.initVariables.between_margin;
                return error.replace('{1}', min).replace('{2}', max);
            }
            return false;
        };

        $scope.getRangeValidationMessage = function(key, val) {

            var min = null;
            var max = null;
            var currencyMax = $scope.getCurrencyMaxRange();
            var error = null;

            if (key === 'range_min') {
                min = 1;
                max = ($.isNumeric($scope.formData.range_max) && $scope.formData.range_max <= currencyMax && $scope.formData.range_max > 0) ? $scope.formData.range_max : currencyMax;
                error = $scope.initVariables.between_range_min;
            } else if (key === 'range_max') {
                min = ($.isNumeric($scope.formData.range_min) && $scope.formData.range_min <= currencyMax && $scope.formData.range_min > 0) ? $scope.formData.range_min : 1;
                max = currencyMax;
                error = $scope.initVariables.between_range_max;
            }

            if (error && (val < min || val > max)) {
                return error.replace('{1}', min).replace('{2}', max);
            }
            return false;
        };

        $scope.getPredefinedAmountsValidationMessage = function() {
            if (!$scope.formData.predefinedAmounts) {
                return;
            }
            var min = 1;
            var max = $scope.getCurrencyMaxRange();
            if (($scope.formData.range_min < min || $scope.formData.range_min > max) || ($scope.formData.range_max < min || $scope.formData.range_max > max)) {
                var error = $scope.initVariables.between_predefined_amount;
                return error.replace('{1}', min).replace('{2}', max);
            }
            return false;
        };

        $scope.getCurrencyMaxRange = function() {
            return $scope.formData.currency_ngmodel ? currency_max_range($scope.formData.currency_ngmodel.rate_USD, $scope.initVariables.fiat_max) : $scope.initVariables.fiat_max;
        };

        $scope.getPaymentWindowValidationMessage = function() {
            var min = $scope.initVariables.payment_window_min;
            var max = $scope.initVariables.payment_window_max;
            var val = $scope.formData.payment_window;
            if (val < min || val > max) {
                return $scope.initVariables.between_payment_window;
            }
            return false;
        };

        $scope.getNextStepTitle = function(stepName) {
            if ($scope.isLastStep(stepName)) return '';

            var currentStepNumericalValue = $scope.getCurrentStepNumericalValue(stepName);
            return $scope.stepsInfo[currentStepNumericalValue + 1].title;
        };

        $scope.getPreviousStepTitle = function(stepName) {
            if (!$scope.canGoBack(stepName)) return '';

            var currentStepNumericalValue = $scope.getCurrentStepNumericalValue(stepName);
            return $scope.stepsInfo[currentStepNumericalValue - 1].title;
        };

        $scope.getNextStepObject = function(stepName) {
            var currentStepNumericalValue = $scope.getCurrentStepNumericalValue(stepName);
            return $scope.stepsInfo[currentStepNumericalValue + 1];
        };

        $scope.getPreviousStepObject = function(stepName) {
            var currentStepNumericalValue = $scope.getCurrentStepNumericalValue(stepName);
            return $scope.stepsInfo[currentStepNumericalValue - 1];
        };

        $scope.isLastStep = function(stepName) {
            var stepIndex = $scope.getCurrentStepNumericalValue(stepName);

            return stepIndex >= 3;
        };

        $scope.getPaymentMethodObject = function() {
            return getObjects($scope.paymentMethods, 'id', $scope.formData.payment_method_id)[0];
        };

        $scope.getSelectedPaymentMethodName = function() {
            return $scope.formData.payment_method_id ? $scope.getPaymentMethodName($scope.getPaymentMethodObject()) : Lang.get('js.create_offer.payment_method_below');
        };

        $scope.getPaymentMethodName = function(paymentMethod) {
            return paymentMethod ? he.decode(paymentMethod.name) : null;
        };

        $scope.getBtcRate = function() {
            if (!$scope.initVariables.btc_usd_rate || !$scope.formData.currency_ngmodel) return 0;
            var btcCurrencyMarketprice = $scope.initVariables.btc_usd_rate * $scope.formData.currency_ngmodel.rate_USD;
            return Number(btcCurrencyMarketprice);
        };

        $scope.unselectPaymentMethod = function() {
            $scope.formData.payment_method_id = null;
            $scope.selectedPaymentMethod = null;
        };

        $scope.selectPaymentMethod = function(methodID) {
            $scope.formData.payment_method_id = methodID;
            $scope.selectedPaymentMethod = getObjects($scope.paymentMethods, 'id', methodID)[0];
            $scope.changeMethodGroup($scope.selectedPaymentMethod.payment_method_group_id);
        };

        $scope.isSelectedPaymentMethodBankTransfer = function() {
            return _.contains($scope.initVariables.bank_transfers_payment_methods, $scope.formData.payment_method_id);
        };

        $scope.changeMethodGroup = function(groupID) {
            $rootScope.activeGroup = groupID;
        };

        $scope.currentStep = $scope.getCurrentStepObject();

        // Watcher: Programmatically checks form data object.
        $scope.$watch('formData', function(newValue, oldValue) {

            // Remove old items from step error object when form data object is updated.
            angular.forEach($scope.currentStep.validations, function(value, key) {
                if (newValue[key]) {
                    delete $scope.formErrorData[$scope.currentStepName][key];
                    delete $scope.formErrorData.server[key];
                }
            });
        }, true);

        // Watcher: Programmatically checks if current step error object gets new values.
        $scope.$watch('formErrorData[currentStepName]', function(newValue, oldValue) {
            if (newValue) $scope.stepHasErrors = Object.keys(newValue).length > 0;
        }, true);

        $scope.$watch('stepsInfo', function(newValue, oldValue) {
            var stepObject = getObjects(newValue, 'active', true)[0];

            if ($state.$current.name !== stepObject.value) {
                $state.go(stepObject.value);
            }
        }, true);

        // Broadcast: We need this broadcast to share step data with header controller not included in view.
        $rootScope.$broadcast('stepsInfo', $scope.stepsInfo);

        $transitions.onEnter({ }, function($transitions) {
            $rootScope.showSpinners = true;
        });

        $transitions.onSuccess({ }, function($transitions) {
            $rootScope.showSpinners = false;
            $scope.currentStepName = $transitions.$to().name;
            $scope.currentStep = $scope.getCurrentStepObject();
            $scope.nextStepButtonText = $scope.currentStepName === 'step3' ? ($scope.initVariables.edit ? Lang.get('js.create_offer.update_offer') : Lang.get('js.create_offer.create_offer')) : Lang.get('js.create_offer.next_step');
        });

        /// MODALS

        $scope.modalShown = false;

        $scope.showTermsAgreementModal = function() {
            $scope.showModal('/create-offer-app/offer-terms-modal', 'AgreementModalCtrl', {
                _token: $rootScope.formData._token
            }, function(result) {
                $scope.modalShown = false;
                if (result && result.data) {
                    $scope.initVariables.is_vendor = result.data.is_vendor;
                    $scope.offerAgreementMessage = result.data.is_vendor ? false : result.data.message;
                    if (result.data.is_vendor) {
                        createNewOffer();
                    }
                }
            });
        };

        $scope.deleteOffer = function() {
            if ($scope.modalShown) return;
            $scope.modalShown = true;
            var modalData = {
                _token: $rootScope.formData._token,
                offer_hash: $rootScope.formData.offer_hash
            };
            $rootScope.resetError();
            $scope.deleteInProgress = true;
            ModalService.showModal({
                templateUrl: '/create-offer-app/offer-delete-modal',
                controller: 'DeleteModalCtrl',
                inputs: { modalData: modalData, scope: $scope }
            }).then(function(modal) {
                $scope.deleteInProgress = false;
                modal.element.modal();
                modal.close.then(function(result) {
                });
                modal.element.on('hidden.bs.modal', function () {
                    $scope.modalShown = false;
                });
            }).catch(function(error) {
                $scope.deleteInProgress = false;
                $scope.modalShown = false;
                $scope.handleError(error);
            });
        };

        $scope.showTagSuggestionModal = function() {
            $scope.showModal('/create-offer-app/suggest-tag-modal', 'DefaultModalCtrl', {}, function(result) {});
        };

        $scope.showMethodSuggestionModal = function() {
            $scope.showModal('/create-offer-app/method-suggest-modal', 'DefaultModalCtrl', {}, function(result) {});
        };

        $scope.showTagsListModal = function() {
            $scope.showModal('/create-offer-app/tags-list-modal', 'DefaultModalCtrl', {}, function(result) {});
        };

        $scope.showModal = function(templateUrl, controller, modalData, closeThenFunction) {
            if ($scope.modalShown) return;
            $scope.modalShown = true;
            $rootScope.resetError();
            ModalService.showModal({
                templateUrl: templateUrl,
                controller: controller,
                inputs: { modalData: modalData }
            }).then(function(modal) {
                modal.element.modal();
                $scope.showSpinners = false;
                modal.close.then(closeThenFunction);
                modal.element.on('hidden.bs.modal', function () {
                    $scope.modalShown = false;
                });
            }).catch(function(error) {
                $scope.modalShown = false;
                $scope.handleError(error);
            });
        };

    }
]);

// Payment method controller.
createOfferApp.controller('PaymentMethodCtrl', ['$scope', 'offerLibrary', 'ModalService', '$rootScope',
    function ($scope, offerLibrary, ModalService, $rootScope) {

        $rootScope.resetError();

        $scope.anchorScroll('create-offer-app');

        // Static values
        $scope.activeToggle = 'left';
        $scope.paymentMethodLimit = 10000;
        $scope.formData.currency = $scope.formData.currency || 144;
        $scope.formData.currency_ngmodel = getObjects($scope.selectOptions.currencies, 'id', $scope.formData.currency)[0];
        $scope.selectedPaymentMethod = null;

        $scope.orderByValue = 'week_avg_profit';
        $scope.reverse = true;

        // Payment method groups
        $scope.paymentMethodGroups = [
            { id: 1, name: Lang.get('js.create_offer.gift_cards') },
            { id: 2, name: Lang.get('js.create_offer.cash_deposits') },
            { id: 3, name: Lang.get('js.create_offer.online_transfers') },
            { id: 4, name: Lang.get('js.create_offer.debit_credit_cards') }
        ];

        // Page functions
        $scope.isActiveGroup = function(groupID) {
            return $rootScope.activeGroup === groupID;
        };

        $scope.toggleFilter = function() {
            $scope.activeToggle = $scope.activeToggle === 'left' ? 'right' : 'left';
        };

        // Payment method functions
        $scope.getPaymentMethodsByGroup = function(groupID) {
            return groupID === 'all' ? $scope.paymentMethods : getObjects($scope.paymentMethods, 'payment_method_group_id', groupID);
        };

        $scope.getActiveMethodGroupName = function() {
            return getObjects($scope.paymentMethodGroups, 'id', $scope.activeGroup)[0].name;
        };

        $scope.changePaymentMethodLimit = function() {
            $scope.paymentMethodLimit = $scope.paymentMethodLimit === 5 ? 10000 : 5;
        };

        // Sorting payment method columns
        $scope.setOrderByValue = function(value) {

            if (value === 'name' && $scope.reverse === true) {
                $scope.reverse = false;
            } else if ($scope.orderByValue === value){
                $scope.reverse = !$scope.reverse;
            }

            $scope.orderByValue = value;
        };

        $scope.paymentMethodComparator = function(v1, v2) {
            if ($scope.orderByValue === 'week_avg_profit') {
                // if both week_avg_profit are nulls - order by id, since earlier added pm's are probably most popular
                // if one has week_avg_profit, it means it is more popular than second one which doesn't have
                // if both have - just sort it by value
                if (v1.type === 'string' && v2.type === 'string') {
                    return (v1.index < v2.index) ? 1 : -1;
                }
                if (v1.type === 'string') {
                    return -1;
                }
                if (v2.type === 'string') {
                    return 1;
                }
                return (v1.value < v2.value) ? -1 : 1;
            } else if ($scope.orderByValue === 'name') {
                return v1.value.localeCompare(v2.value);
            } else {
                // implement custom comparator for further column if needed
            }
        };

        // Watchers
        $scope.$watch('formData.currency_ngmodel', function(newValue, oldValue) {
            $scope.formData.currency = newValue ? newValue.id : null;
        });

        if ($scope.initVariables.edit) {
            $scope.formData.currency_ngmodel = getObjects($scope.selectOptions.currencies, 'id', $scope.initVariables.editParams.currency)[0];
        }
    }
]);

// Margin and min/max amount controller.
createOfferApp.controller('MoneyCtrl', ['$scope', '$rootScope', 'offerLibrary', 'ModalService',
    function ($scope, $rootScope, offerLibrary, ModalService) {

        $rootScope.resetError();

        $scope.anchorScroll('create-offer-app');

        $scope.bondRequired = $scope.getPaymentMethodObject().payment_method_group_id === 1 && $scope.initVariables.bond_required;

        var defaultAmounts = [
            {id: 25,  name: 25},
            {id: 50,  name: 50},
            {id: 75,  name: 75},
            {id: 100, name: 100},
        ];

        var amounts = null;
        if ($scope.stepBack || $scope.formData.predefinedAmountsEditMode) {
            amounts = $scope.formData.predefined_amount;
        }
        if (amounts) {
            $scope.formData.predefined_amount_ngmodel = amounts.map(function (x) {
                return {id: x, name: x};
            });
            $scope.amounts_options = arrayUnique(defaultAmounts.concat($scope.formData.predefined_amount_ngmodel));
        } else {
            $scope.amounts_options = defaultAmounts;
        }

        $scope.rate_BTC_profit = 0;

        // has some abstract problems but works as expected in this case
        function isInt(n) {
            return n % 1 === 0;
        }

        $scope.formData.margin = $scope.formData.margin ? (isInt($scope.formData.margin) ? parseInt($scope.formData.margin) : $scope.formData.margin) : 5;
        $scope.formData.payment_window = $scope.formData.payment_window || ($scope.getPaymentMethodObject() ? $scope.getPaymentMethodObject().payment_window : 30);

        $scope.accountCryptoValue = $scope.initVariables.btc_amount;
        $scope.accountFiatValue = Number($scope.accountCryptoValue) * $scope.getBtcRate();

        // Modal for Minimum bond requirement
        $scope.fundModalShown = false;
        $scope.showFundModal = function(type) {

            if ($scope.fundModalShown)
                return;

            var modalData = {
                highestLimitValue: $scope.formData.predefinedAmounts ? Math.max.apply(Math, $scope.formData.predefined_amount_ngmodel) : Math.max($scope.formData.range_min, $scope.formData.range_max),
                accountValue: $scope.accountFiatValue,
                selectedCurrency: $scope.formData.currency_ngmodel,
                type: type,
                bondAmount: $scope.minimumSystemBondRequirement
            };

            $rootScope.resetError();
            $scope.fundModalShown = true;
            ModalService.showModal({
                templateUrl: '/create-offer-app/fund-account-modal',
                controller: 'FundModalCtrl',
                inputs: { modalData: modalData }
            }).then(function(modal) {
                modal.element.modal();
                modal.close.then(function(result) {
                });
                modal.element.on('hidden.bs.modal', function () {
                    $scope.fundModalShown = false;
                });
            }).catch(function(error) {
                $scope.fundModalShown = false;
                $rootScope.handleError(error);
            });
        };

        $scope.showHidePredefined = function() {
            $scope.formData.predefinedAmounts = !$scope.formData.predefinedAmounts;
        };

        $scope.getBitcoinValue = function(value) {
            return Number(value) / $scope.getBtcRate();
        };

        // Watch margin
        $scope.$watch('formData.margin', function(newVal, oldVal) {
            // Calculate profit
            var percentage = newVal/100,
                profit = $scope.getBtcRate() * Number(percentage);

            $scope.rate_BTC_profit = $scope.getBtcRate() + Number(profit);
            $scope.pureProfit = Number($scope.rate_BTC_profit) - $scope.getBtcRate();
        });

        $scope.minimumSystemBondRequirement = 0.1; // Dependent on payment method.
        $scope.minimumBondRequired = $scope.accountCryptoValue < $scope.minimumSystemBondRequirement;

        // Watch limits to calculate if topup is required
        $scope.$watchGroup(['formData.range_min', 'formData.range_max'], function(newValues, oldValues) {
            $scope.checkLimits();
        });

        $scope.$watch('formData.predefined_amount_ngmodel', function() {
            // hack for the bug of the scania-angular-select2, whish is not applies custom tags to the model
            if (!$scope.formData.predefinedAmounts) {
                return;
            }

            var val = $('select[id="defined-amounts"]').val();
            if (!val &&
                $scope.formData.predefined_amount &&
               ($scope.formData.predefinedAmountsEditMode || $scope.stepBack)
            ) {
                val = $scope.formData.predefined_amount;
                $scope.formData.predefinedAmountsEditMode = false;
                $scope.stepBack = false;
            }

            if (!val || !_.isArray(val) || !val.length) {
                $scope.formData.range_min = null;
                $scope.formData.range_max = null;
                $scope.formData.predefined_amount = null;
            } else {
                var predefined_amount = val.map(function (x) {
                    return parseInt(x, 10);
                });
                predefined_amount.sort(function (a,b) { return a - b; });
                $scope.formData.range_min = predefined_amount[0];
                $scope.formData.range_max = predefined_amount[predefined_amount.length - 1];
                $scope.formData.predefined_amount = predefined_amount;
            }
            $scope.checkLimits();
        });

        $scope.checkLimits = function() {
            $scope.isOfferWontBeVisible = $scope.formData.range_min > $scope.accountFiatValue;
            $scope.isRangeMaxWillBeAdjusted = $scope.formData.range_max > $scope.accountFiatValue;

        };

        $scope.isRangeMinValid = function() {
            return !$scope.getValidationMessage('range_min', $scope.formData.range_min);
        };

        $scope.isRangeMaxValid = function() {
            return !$scope.getValidationMessage('range_max', $scope.formData.range_max);
        };

        $scope.isRangeValid = function() {
            return $scope.isRangeMinValid() && $scope.isRangeMaxValid();
        };

        $scope.isOfferVisibilityExplanationVisible = function() {
            return $scope.isRangeValid() && $scope.isOfferWontBeVisible;
        };

        $scope.isRangeMaxAdjustmentExplanationVisible = function() {
            return $scope.isRangeValid() && !$scope.isOfferWontBeVisible && $scope.isRangeMaxWillBeAdjusted;
        };

        $scope.getMaxRangeForEscrowExplanation = function() {
            if ($scope.isRangeMinValid() && $scope.isRangeMaxValid()) {
                return $scope.formData.range_max;
            }
            return 50;
        };
    }
]);

createOfferApp.controller('TermsCtrl', ['$scope', 'offerLibrary', 'offerTags', '$rootScope',
    function ($scope, offerLibrary, offerTags, $rootScope) {

        $rootScope.resetError();

        $scope.anchorScroll('create-offer-app');
        $scope.offerTags = offerTags.data;

        $scope.getTagById = function (id) {
            var tag = null;
            angular.forEach($scope.offerTags, function (value, key) {
                if (value.id == id) {
                    tag = value;
                    return;
                }
            })
            return tag;
        }

        $scope.formData.tags_ngmodel = [];
        angular.forEach($scope.formData.tags, function(value, key) {
            var tag = $scope.getTagById(value);
            if (tag) {
                $scope.formData.tags_ngmodel.push(tag);
            }
        });

        $scope.advancedOpened = true;
        if ($scope.isMobileView) {
            $scope.advancedOpened = false;
        } else if ($scope.initVariables.edit &&
            !$scope.formData.require_verified_email &&
            !$scope.formData.require_verified_phone &&
            !$scope.formData.show_only_trusted_user &&
            !$scope.formData.require_min_past_trades &&
            !$scope.formData.country_limitation_type) {
            $scope.advancedOpened = false;
        }

        // When the tags select is being edited.
        $scope.$watch('formData.tags_ngmodel', function(newValue, oldValue) {
            var selectedTagsArray = [];
            angular.forEach(newValue, function(value, key) {
                value.selected = true;
                selectedTagsArray.push(value.id);
            });
            $scope.formData.tags = selectedTagsArray;
        });

        $scope.formData.country_limitation_type = $scope.formData.country_limitation_type || 0;

        $scope.switchEmailVerification = function () {
            $scope.formData.require_verified_email = $scope.formData.require_verified_email ? 0 : 1;
        }

        $scope.switchPhoneVerification = function () {
            $scope.formData.require_verified_phone = $scope.formData.require_verified_phone ? 0 : 1;
        }

        $scope.switchOnlyTrustedUsers = function () {
            $scope.formData.show_only_trusted_user = $scope.formData.show_only_trusted_user ? 0 : 1;
        }

        $scope.$watch('formData.country_limitation_type', function(newVal, oldVal) {
            var select = $('select[id="country-limitations"]');
            if ($scope.formData.country_limitation_type == 1 || $scope.formData.country_limitation_type == 2) {
                select.prop('disabled','');
            } else {
                $scope.formData.country_limitation_list = null;
                select.prop('disabled','disabled');
            }
        });

    }
]);

createOfferApp.controller('DefaultModalCtrl', ['$scope', 'offerLibrary', 'modalData',
    function ($scope, offerLibrary, modalData) {

        $scope.modalData = modalData;

        $scope.redirectTo = function(redirectLink) {
            window.location.href = redirectLink;
        };

        $scope.decode = function(str) {
            return str.replace(/&#(\d+);/g, function(match, dec) {
                return String.fromCharCode(dec);
            });
        }
    }
]);

createOfferApp.controller('FundModalCtrl', ['$scope', 'offerLibrary', 'modalData',
    function ($scope, offerLibrary, modalData) {

        $scope.highestLimitValue = modalData.highestLimitValue;
        $scope.accountValue = modalData.accountValue.toFixed(2);
        $scope.selectedCurrency = modalData.selectedCurrency;
        $scope.type = modalData.type;
        $scope.minimumBondAmount = modalData.bondAmount;
    }
]);

createOfferApp.controller('AgreementModalCtrl', ['$scope', '$rootScope', '$element', 'offerLibrary', 'close', 'modalData',
    function ($scope, $rootScope, $element, offerLibrary, close, modalData) {
        $scope.closeAgreementModal = function(response) {
            if (response) {
                modalData.vendor_terms_action = response;
                var btn = angular.element('#' + response + '-terms');
                if (!btn) return;
                btn.ladda().ladda('start');
                var handleError = function (reason) {
                    $rootScope.handleError(reason);
                    close(response, 200);
                }
                offerLibrary.postHandleVendorTerms(modalData, handleError).then(function(response) {
                    close(response, 200);
                });
            }
        };
        this.processBackdropClick = function () {
            close(null, 200);
        }
    },
]);

createOfferApp.controller('DeleteModalCtrl', ['$scope', 'offerLibrary', 'close', 'modalData', 'scope',
    function ($scope, offerLibrary, close, modalData, scope) {

        scope.deleteErrorMessage = false;

        $scope.deleteOffer = function() {

            scope.deleteInProgress = true;

            offerLibrary.getDeleteOffer(modalData, scope.handleError).then(function(response) {
                if (response.data.status === 'success') {
                    window.location.href = '/dashboard';
                } else {
                    scope.deleteErrorMessage = response.data.message;
                }
                scope.deleteInProgress = false;
                close(response.data, 200);
            });
        }
    }
]);

// Video controller
createOfferApp.controller('VideoCtrl', ['$scope', 'ModalService',
    function ($scope, ModalService) {

        // Opens video tutorial modal

        $scope.playVideo = function(video_url) {

            ModalService.showModal({
                templateUrl: '/create-offer-app/video-modal',
                controller: function ($scope, video_url) {
                    $scope.video_url = video_url;
                },
                inputs: { video_url: video_url }
            }).then(function(modal) {
                modal.element.modal();
                modal.close.then(function(result) {

                });
            });
        };
    }
]);

// API service.
createOfferApp.factory('offerLibrary', ['$http', '$q', '$window', '$rootScope', function($http, $q, $window, $rootScope) {

    var returnObjects = {
        getPaymentMethods: function () {
            var deferred = $q.defer();
            $http({method: 'GET', url: '/offer-manager/payment-methods'})
                .then (function (data) {
                    deferred.resolve(data);
                },  function(reason) {
                    $rootScope.handleError(reason);
                });
            return deferred.promise;
        },
        getCurrencies: function () {
            var deferred = $q.defer();
            $http({method: 'POST', url: '/home/fiat-currencies'})
                .then (function (data) {
                    deferred.resolve(data);
                },  function(reason) {
                    $rootScope.handleError(reason);
                });
            return deferred.promise;
        },
        getOfferTags: function () {
            var deferred = $q.defer();
            $http({method: 'GET', url: '/offer-manager/tags'})
                .then (function (data) {
                    deferred.resolve(data);
                },  function(reason) {
                    $rootScope.handleError(reason);
                });
            return deferred.promise;
        },
        saveStateData: function (appData) {
            $window.sessionStorage.setItem('createOfferApp', angular.toJson(appData));
        },
        saveStateDataExact: function (key, value) {
            var currentAppData = angular.fromJson($window.sessionStorage.getItem('createOfferApp')) || {};
            currentAppData[key] = value;
            $window.sessionStorage.setItem('createOfferApp', angular.toJson(currentAppData));
        },
        getStateDataExact: function (itemKey) {
            var currentAppData = angular.fromJson($window.sessionStorage.getItem('createOfferApp'));
            if (currentAppData) {
                return currentAppData[itemKey] ? currentAppData[itemKey] : null;
            } else {
                return null;
            }
        },
        cleanStateData: function () {
            $window.sessionStorage.removeItem('createOfferApp');
        },
        postNewOffer: function (formData) {
            var deferred = $q.defer();
            $http({
                method: 'POST',
                headers: {
                    'X-Requested-With' :'XMLHttpRequest',
                    'Content-Type': 'application/x-www-form-urlencoded; charset=utf-8'
                },
                url: '/offer-manager/save',
                transformRequest: function(data) {
                    if (data === undefined) {
                        return data;
                    }
                    return $.param(data);
                },
                data: formData
            }).then (function (data) {
                deferred.resolve(data);
            },  function(reason) {
                $rootScope.handleError(reason);
            });
            return deferred.promise;
        },
        getDeleteOffer: function (offerData, handleError) {
            var deferred = $q.defer();
            $http({
                method: 'GET',
                headers: {
                    'X-Requested-With' :'XMLHttpRequest',
                    'Content-Type': 'application/x-www-form-urlencoded; charset=utf-8'
                },
                url: '/offer-manager/delete/' + offerData.offer_hash + '?token=' + offerData._token,
                transformRequest: function(data) {
                    if (data === undefined) {
                        return data;
                    }
                    return $.param(data);
                }
            }).then (function (data) {
                deferred.resolve(data);
            },  function(reason) {
                handleError(reason);
            });
            return deferred.promise;
        },
        postHandleVendorTerms: function (formData, handleError) {
            var deferred = $q.defer();
            $http({
                method: 'POST',
                headers: {
                    'X-Requested-With' :'XMLHttpRequest',
                    'Content-Type': 'application/x-www-form-urlencoded; charset=utf-8'
                },
                url: '/vendor/handle-vendor-terms',
                transformRequest: function(data) {
                    if (data === undefined) {
                        return data;
                    }
                    return $.param(data);
                },
                data: formData
            }).then (function (data) {
                deferred.resolve(data);
            },  function(reason) {
                handleError(reason);
            });
            return deferred.promise;
        },
        handleStateError: function (step) {
            $http.get('/create-offer-app/' + step, {})
                .then(function(data) {
                    // do nothing
                }, function(reason) {
                    $rootScope.handleError(reason);
                    return $q.reject(reason);
                });
        },
    }

    return returnObjects;
}]);

// Directive for tooltips
createOfferApp.directive('tooltip', [function(){
    return {
        restrict: 'A',
        link: function(scope, element, attrs){
            $(element).hover(function(){
                // on mouseenter
                $(element).tooltip('show');
            }, function(){
                // on mouseleave
                $(element).tooltip('hide');
            });
        }
    };
}]);

// Directive for youtube iframe
createOfferApp.directive('videoTutorial', [function(){
    return {
        restrict: 'A',
        link: function(scope, element, attrs) {
            attrs.$observe('videoLink', function(value) {
                $(element).append('<iframe width="560" height="315" src="' + value + '" frameborder="0" allowfullscreen></iframe>');
                var $videoModal = $('#video-modal');
                $videoModal.on('hidden.bs.modal', function () {
                    $("iframe", $videoModal).attr("src", $("iframe", $videoModal).attr("src"));
                })
            });
        }
    };
}]);

// Directive for copying link on kliikk
createOfferApp.directive('clipboardCopy', [function(){
    return {
        restrict: 'A',
        link: function(scope, element, attrs) {
            var $clipboardButton = $('.btn-clipboard', $(element)),
                clipboard = new Clipboard($clipboardButton.selector);

            clipboard.on('success', function(e) {
                $clipboardButton.tooltip({title: 'Copied!', placement: 'top', container: 'body'}).tooltip('show');
                $clipboardButton.on('hidden.bs.tooltip', function () {
                    $clipboardButton.tooltip('destroy');
                });
            });
        }
    };
}]);

// Directive for payment method suggestion modal
createOfferApp.directive('methodSuggestModal', ['ModalService', function(ModalService){
    return {
        restrict: 'A',
        link: function(scope, element, attrs) {
            $(document).ready(function(e) {

                var $form = $('form#suggest-payment-method-form', $(element));

                initModalServiceForm($form);

                var $description = $('#add-pm-description-short', $(element));
                $description.bind("change keyup", function(e) {
                    var counter = this.maxLength - this.value.length;
                    if (counter >= 0) {
                        document.getElementById('pm-description-short-counter').innerText = counter;
                    } else {
                        e.preventDefault();
                    }
                });
            });
        }
    };
}]);

// Directive for tag suggestion modal
createOfferApp.directive('tagSuggestModal', ['ModalService', function(ModalService){
    return {
        restrict: 'A',
        link: function(scope, element, attrs) {
            $(document).ready(function(e) {
                var $form = $('form#suggest-tag-form', $(element));

                initModalServiceForm($form);
            });
        }
    };
}]);

// Filters
createOfferApp.filter('makePositive', function() {
    return function(num) { return Math.abs(num); }
});

// Helper functions.
function getObjects(obj, key, val) {
    var objects = [];
    for (var i in obj) {
        if (!obj.hasOwnProperty(i)) continue;
        if (typeof obj[i] == 'object') {
            objects = objects.concat(getObjects(obj[i], key, val));
        } else if (i == key && obj[key] == val) {
            objects.push(obj);
        }
    }
    return objects;
}

function arrayUnique(array) {
    if (!array || !_.isArray(array) || !array.length) {
       return [];
    }
    var unique = [];
    for(var i = 0; i < array.length; i++) {
        if (_.findWhere(unique, array[i]) == null) {
            unique.push(array[i]);
        }
    }
    return unique;
}

function isNotEmptyArray(array) {
    return array && _.isArray(array) && (array.length > 0);
}

function initModalServiceForm($form) {
    $form[0].reset();
    $form.find(".help-block-error").empty();
    $form.find(".form-group").removeClass('has-error');
    $form.find(".modal-body.success-body").hide();
    $form.find('.modal-body.default-body').show();
    $form.find(".modal-footer").show();

    $form.submit(function(e) {
        e.preventDefault();

        var submitButton = $form.find("button.submit-button"),
            ladda = Ladda.create(submitButton[0]);

        $form.find(".error-summary").hide();
        $form.find(".help-block-error").empty();
        $form.find(".form-group").removeClass('has-error');

        ladda.start();
        $.post($form.attr('action'), $form.serialize())
            .then(function(response) {
                if (response.success === false && response.errors) {
                    for (var attribute in response.errors) {
                        if (response.errors.hasOwnProperty(attribute)) {
                            var block = $(".help-block-error[data-attribute=" + attribute + "]", $form);
                            block.text(response.errors[attribute][0]); //only show first error
                            block.parents(".form-group").addClass('has-error');
                        }
                    }
                } else if (response.success) {
                    $form.find(".modal-body.default-body").hide();
                    $form.find(".modal-body.success-body").show();
                    $form.find(".modal-footer").hide();
                    window.setTimeout(function() {
                        //hide modal after showing success after 3 seconds
                        $form.parents(".modal").modal('hide');
                    }, 5000);
                } else {
                    $form.find(".error-summary").text(response.message).show();
                }
            })
            .fail(function () {
                $form.find(".error-summary").text("Unknown error, admins notified.").show();
            })
            .always(function() {
                ladda.stop();
            });
    });
};

/* THIS PLUGIN IS REWRITED DUE TO FIX ANGULAR MODEL UPDATE FOR CUSTOM TAGS */
/* DO NOT MOVE IT TO SEPARATED FILE! */
/**
 * scania-angular-select2
 * https://github.com/scania-bootstrap/scania-angular-select2
 * License: MIT
 *
 * @description AngularJS directive for Select2
 */
(function () {
    'use strict';
    /**
     * @ngdoc module
     * @name scania.angular.select2
     *
     * @description
     * Scania select2 directive module
     */
    angular.module('scania.angular.select2', []);

    /**
     * @ngdoc directive
     * @name scSingleSelect
     * @module scania.angular.select2
     *
     * @description AngularJS directive for single select
     * @param $compile
     * @param $timeout
     * @returns {{restrict: string, scope: {ngModel: string, templateSelection: Function, templateResult: Function, matcher: Function, createSearchChoice: Function}, link: Function}}
     */
    angular.module('scania.angular.select2').directive('scSingleSelect', ['$compile', '$timeout', scSingleSelect]);
    /**
     * @ngdoc directive
     * @name scMultiSelect
     * @module scania.angular.select2
     *
     * @description AngularJS directive for multi select
     * @param $compile
     * @param $timeout
     * @returns {{restrict: string, scope: {ngModel: string, templateSelection: Function, templateResult: Function, matcher: Function, createSearchChoice: Function}, link: Function}}
     */
    angular.module('scania.angular.select2').directive('scMultiSelect', ['$compile', '$timeout', scMultiSelect]);
    /**
     * @ngdoc directive
     * @name scInputSelect
     * @module scania.angular.select2
     *
     * @description AngularJS directive for input select tokenizer
     * @param $compile
     * @param $timeout
     * @returns {{restrict: string, scope: {ngModel: string, templateSelection: Function, templateResult: Function, matcher: Function, createSearchChoice: Function, tokenSeparators: Function}, link: Function}}
     */
    angular.module('scania.angular.select2').directive('scInputSelect', ['$compile', '$timeout', scInputSelect]);

    /**
     * @ngdoc method
     * @name scania.angular.select2#init
     * @methodOf scania.angular.select2
     *
     * @description
     * Initialize a select component
     *
     */
    function init($scope, element, $attr, $compile) {
        if ($attr.language) {
            var domElem = '<script src="/bower_components/select2/select2_locale_' + $attr.language + '.js" async defer></script>';
            $(element).append($compile(domElem)($scope));
        }
        var options = _.pick($(element).data(), function (value, key) {
                return !startsWith(key, '$');
            }),
            minimumResultsForSearch = 10,
            defaultWidth = '100%',
            events = 'input keyup';

        options.formatSelection = $scope.templateSelection || $.fn.select2.defaults.formatSelection;
        options.formatResult = $scope.templateResult || $.fn.select2.defaults.formatResult;
        options.matcher = $scope.matcher || $.fn.select2.defaults.matcher;
        options.minimumResultsForSearch = (options.minimumResultsForSearch > 10) ? options.minimumResultsForSearch : minimumResultsForSearch;
        if ($(element).innerWidth() < 49 || !_.includes($(element).attr('style'), 'width')) {
            $(element).attr('style', 'width: ' + defaultWidth);
        }

        $('.select2-input').bind(events, function (event) {
            var minimumInputLength = (options.minimumInputLength) ? options.minimumInputLength : 3;
            if (event.currentTarget.value.length >= minimumInputLength) {
                $scope.$emit('select.search-input', event.currentTarget.value);
            }
        });
        return options;
    }
    /**
     * @ngdoc method
     * @name scania.angular.select2#updateSelectedItemsOnDisplay
     * @methodOf scania.angular.select2
     *
     * @description
     * Updates selected items
     *
     */
    function updateSelectedItemsOnDisplay($scope, select, options, inputOptionsLabelProperty, input) {
        if (!$scope.ngModel) {
            // select.select2("val", "");
            select.select2(options);
            return;
        }

        //True for both single and multiselect
        if ($scope.ngModel.then && typeof $scope.ngModel.then === 'function') {
            $scope.ngModel.then(function (response) {
                //Multi select can have 1 or several default selected options,use each to initialize the select
                //Single select has 1 default selected option, no iteration is needed to initialize the select
                var selectedItems = $attr.multiple ? response.data : new Array(response.data);
                if (input) {
                    populatePreselectedInputOptions(select, selectedItems, options.id, inputOptionsLabelProperty);
                } else {
                    populatePreselectedOptions(select, selectedItems, options.value);
                }
            });
        }
        else {
            if (!_.isArray($scope.ngModel) && !_.isObject($scope.ngModel)) return;
            var selectedItems = _.isArray($scope.ngModel) ? $scope.ngModel : new Array($scope.ngModel);
            if (input) {
                populatePreselectedInputOptions(select, selectedItems, options.id, inputOptionsLabelProperty);
            } else {
                populatePreselectedOptions(select, selectedItems, options.value);
            }
        }
    }
    /**
     * @ngdoc method
     * @name scania.angular.select2#populatePreselectedOptions
     * @methodOf scania.angular.select2
     *
     * @description
     * Prepopulate the select component
     *
     */
    function populatePreselectedOptions(scSelect, selectedItems, key) {
        //throw "Data-value for " + scSelect[0].id +" must have the same value as its track by.";
        var selectedOptions = [];
        _.each(selectedItems, function (selectedItem) {
            var selectedId = selectedItem[key];
            var selectedOption = _.find(scSelect[0], function (option) {
                return selectedId == option.value;
            });
            if (!selectedOption) {
                // console.error("Data-value for " + scSelect[0].id + " must have the same value as its track by.");
                return;
            }
            selectedOptions.push({id: selectedId, text: selectedOption.label});

        });
        if (selectedItems.length == 1) selectedOptions = selectedOptions.pop();
        scSelect.select2('data', selectedOptions);
    }
    /**
     * @ngdoc method
     * @name scania.angular.select2#populatePreselectedInputOptions
     * @methodOf scania.angular.select2
     *
     * @description
     * Prepopulate the input component
     *
     */
    function populatePreselectedInputOptions(scSelect, selectedItems, key, inputOptionsLabelProperty) {
        var selectedOptions = [];
        _.each(selectedItems, function (selectedItem) {
            var option = {};
            option[key] = selectedItem[key];
            option[inputOptionsLabelProperty] = selectedItem[inputOptionsLabelProperty];
            selectedOptions.push(option);
        });
        if (selectedItems.length == 1) selectedOptions = selectedOptions.pop();
        scSelect.select2('data', selectedOptions);
    }
    /**
     * @ngdoc method
     * @name scania.angular.select2#createSelect
     * @methodOf scania.angular.select2
     *
     * @description
     * Creates the select component
     *
     */
    function createSelect($scope, element, $attr, $compile, $timeout) {
        var options = init($scope, element, $attr, $compile),
            select = {},
            scSelect;

        if ($attr.id == 'defined-amounts') {
            options.tokenSeparators =[',', ' '];
            options.maximumSelectionLength = 15;
            options.maximumInputLength = 15;
            options.createTag = function (params) {
                if (params.term.match(/^[0-9]+$/) != null) {
                    return {
                        id: params.term,
                        text: params.term
                    }
                }
                return null;
            };
        }

        $timeout(function () {
            select = $('select[id="' + $attr.id + '"]');
            scSelect = select.select2(options);

            updateSelectedItemsOnDisplay($scope, select, options);
            $scope.watchFunction = _.isArray($scope.ngModel) ? $scope.$watchCollection : $scope.$watch;
            $scope.watchFunction('ngModel', function () {
                updateSelectedItemsOnDisplay($scope, select, options);
            });
            registerEvents($scope, scSelect, options);
        });

    }
    /**
     * @ngdoc method
     * @name scania.angular.select2#registerEvents
     * @methodOf scania.angular.select2
     *
     * @description
     * Register select2 events
     *
     */
    function registerEvents($scope, scSelect, options) {

        scSelect.on('select2-closing', function(event) {
            if(angular.isDefined(options.preventClose)) {
                event.preventDefault();
            }
            $scope.$emit('select.closing', event);
        });
        scSelect.on('select2-close', function(event) {
            $scope.$emit('select.close', event);
        });
        scSelect.on('select2-opening', function(event) {
            if(angular.isDefined(options.preventOpen)) {
                event.preventDefault();
            }
            $scope.$emit('select.opening', event);
        });
        scSelect.on('select2-open', function(event) {
            $scope.$emit('select.open', event);
        });
        scSelect.on('select2-selecting', function(event) {
            if(angular.isDefined(options.preventSelect)) {
                event.preventDefault();
            }
            $scope.$emit('select.selecting', event);
        });
        scSelect.on('select2-selected', function(event) {
            $scope.$emit('select.selected', event);
        });
        scSelect.on('select2-unselecting', function(event) {
            if(angular.isDefined(options.preventUnselect)) {
                event.preventDefault();
            }
            $scope.$emit('select.unselecting', event);
        });
        scSelect.on('select2-unselect', function(event) {
            $scope.$emit('select.unselect', event);
        });
        scSelect.on('select2-clearing', function(event) {
            $scope.$emit('select.clearing', event);
        });
        scSelect.on('select2-removing', function(event) {
            $scope.$emit('select.removing', event);
        });
        scSelect.on('select2-focus select2-blur', function(event) {
            $scope.$emit('select.focus', event);
        });
        scSelect.on('change', function(event) {
            $scope.$emit('select.change', event);
        });
    }
    /**
     * @ngdoc method
     * @name scania.angular.select2#startsWith
     * @methodOf scania.angular.select2
     *
     * @description
     * Check the leading character in a string agains a predicate
     *
     */
    function startsWith(str, target) {
        return str.indexOf(target) === 0;
    }
    /**
     * @ngdoc method
     * @name scania.angular.select2#scSingleSelect
     * @module scania.angular.select2
     *
     * @description AngularJS directive for single select
     * @param $compile
     * @param $timeout
     * @returns {{restrict: string, scope: {ngModel: string, templateSelection: Function, templateResult: Function, matcher: Function, createSearchChoice: Function}, link: Function}}
     */
    function scSingleSelect($compile, $timeout) {
        return {
            restrict: 'A',
            scope: {
                ngModel: '=',
                templateSelection: '=',
                templateResult: '=',
                matcher: '=',
                createSearchChoice: '='
            },
            link: function ($scope, element, $attr) {
                createSelect($scope, element, $attr, $compile, $timeout);
            }
        };

    }
    /**
     * @ngdoc method
     * @name scania.angular.select2#scMultiSelect
     * @module scania.angular.select2
     *
     * @description AngularJS directive for multi select
     * @param $compile
     * @param $timeout
     * @returns {{restrict: string, scope: {ngModel: string, templateSelection: Function, templateResult: Function, matcher: Function, createSearchChoice: Function}, link: Function}}
     */
    function scMultiSelect($compile, $timeout) {
        return {
            restrict: 'A',
            scope: {
                ngModel: '=',
                templateSelection: '=',
                templateResult: '=',
                matcher: '=',
                createSearchChoice: '='
            },
            link: function ($scope, element, $attr) {
                createSelect($scope, element, $attr, $compile, $timeout);
            }
        };
    }
    /**
     * @ngdoc method
     * @name scania.angular.select2#scInputSelect
     * @module scania.angular.select2
     *
     * @description AngularJS directive for input select
     * @param $compile
     * @param $timeout
     * @returns {{restrict: string, scope: {ngModel: string, templateSelection: Function, templateResult: Function, matcher: Function, createSearchChoice: Function, tokenSeparators: Function}, link: Function}}
     */
    function scInputSelect($compile, $timeout) {
        return {
            restrict: 'A',
            scope: {
                ngModel: '=',
                templateSelection: '=',
                templateResult: '=',
                matcher: '=',
                createSearchChoice: '=',
                tokenSeparators: '='
            },
            link: function ($scope, element, $attr) {
                var options = init($scope, element, $attr, $compile),
                    select = {},
                    tokenSeparators = [",", " "],
                    inputOptionsLabelProperty = '';

                $timeout(function () {

                    options.data = {results: JSON.parse($attr.data), text: $attr.label};
                    options.createSearchChoice = $scope.createSearchChoice;
                    options.tokenSeparators = $scope.tokenSeparators || tokenSeparators;
                    options.id = $attr.itemId;
                    inputOptionsLabelProperty = options.label;

                    select = $('input[id="' + $attr.id + '"]');
                    select.select2(options);

                    updateSelectedItemsOnDisplay($scope, select, options, inputOptionsLabelProperty, 'input');
                    $scope.$watch('ngModel', function () {
                        updateSelectedItemsOnDisplay($scope, select, options, inputOptionsLabelProperty, 'input');
                    });
                });
            }
        };
    }
})();

var paymentMethodSample = [{
        "id": 4,
        "name": "Amazon Gift Card",
        "slug": "amazon-gift-card",
        "description_long": "",
        "payment_window": 30,
        "sell_quantity": 59,
        "buy_quantity": 41,
        "has_icon": false,
        "payment_method_group_id": 1,
        "warning_text": "",
        "tags": "instant#private",
        "week_volume": null,
        "week_avg_profit": null,
    },
    {
        "id": 137,
        "name": "iTunes Gift Card Code",
        "slug": "itunes-gift-card-code",
        "description_short": null,
        "description_long": null,
        "payment_window": 90,
        "instructions": null,
        "sell_quantity": 1,
        "buy_quantity": 5,
        "has_icon": false,
        "payment_method_group_id": 1,
        "warning_text": null,
        "tags": "instant#private",
        "week_volume": null,
        "week_avg_profit": null,
    },
    {
        "id": 136,
        "name": "eBay Gift Card",
        "slug": "ebay-gift-card",
        "description_short": "",
        "description_long": "",
        "payment_window": 90,
        "instructions": "",
        "sell_quantity": 4,
        "buy_quantity": 3,
        "has_icon": false,
        "payment_method_group_id": 1,
        "warning_text": "",
        "tags": "instant#private",
        "week_volume": null,
        "week_avg_profit": null,
    },
    {
        "id": 381,
        "name": "Steam Wallet Code",
        "slug": "steam-wallet-code",
        "description_short": null,
        "description_long": null,
        "payment_window": 30,
        "instructions": null,
        "sell_quantity": 0,
        "buy_quantity": 2,
        "has_icon": false,
        "payment_method_group_id": 1,
        "warning_text": null,
        "tags": "instant#private",
        "week_volume": null,
        "week_avg_profit": null,
    },
    {
        "id": 195,
        "name": "OneVanilla VISA/MasterCard Gift Card",
        "slug": "onevanilla-visamastercard-gift-card",
        "description_short": "",
        "description_long": "",
        "payment_window": 90,
        "instructions": "",
        "sell_quantity": 17,
        "buy_quantity": 22,
        "has_icon": false,
        "payment_method_group_id": 1,
        "warning_text": "",
        "tags": "instant#private",
        "week_volume": null,
        "week_avg_profit": null,
    },
    {
        "id": 49,
        "name": "Walmart Gift Card",
        "slug": "walmart-gift-card",
        "description_short": null,
        "description_long": null,
        "payment_window": 90,
        "instructions": null,
        "sell_quantity": 8,
        "buy_quantity": 20,
        "has_icon": false,
        "payment_method_group_id": 1,
        "warning_text": null,
        "tags": "instant#private",
        "week_volume": null,
        "week_avg_profit": null,
    }];